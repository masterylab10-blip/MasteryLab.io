<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign In | MasteryLab</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600&family=Anton&display=swap"
        rel="stylesheet">
    <link rel="icon" href="media/favicon.png" type="image/png">
</head>

<body>

    <!-- Navigation -->
    <nav class="navbar">
        <div class="container">
            <a href="index.html" class="logo">
                <img src="media/logo-wings.png" alt="MasteryLab Logo">
            </a>
            <div class="nav-links">
                <!-- Additional nav links if needed -->
            </div>
        </div>
    </nav>

    <!-- Auth Container -->
    <div class="auth-container">
        <div class="auth-card-dark">

            <!-- Tabs -->
            <div class="auth-tabs">
                <button id="tabSignIn" class="auth-tab active" onclick="switchView('signIn')">Sign In</button>
                <button id="tabSignUp" class="auth-tab" onclick="switchView('signUp')">Create Account</button>
            </div>

            <!-- Sign In View -->
            <div id="signInView">
                <form id="signInForm">
                    <div style="margin-bottom: 1.5rem;">
                        <label class="auth-label-dark" for="signInEmail">EMAIL ADDRESS</label>
                        <input type="email" id="signInEmail" class="auth-input-dark" required>
                    </div>
                    <div style="margin-bottom: 1.5rem;">
                        <label class="auth-label-dark" for="signInPassword">PASSWORD</label>
                        <input type="password" id="signInPassword" class="auth-input-dark" required>
                    </div>

                    <button type="submit" class="btn-auth-red">SIGN IN</button>
                </form>
            </div>

            <!-- Sign Up View -->
            <div id="signUpView" style="display: none;">
                <form id="signUpForm">
                    <div class="auth-form-grid">
                        <!-- Row 1: Names -->
                        <div>
                            <label class="auth-label-dark" for="signUpFirstName">FIRST NAME</label>
                            <input type="text" id="signUpFirstName" class="auth-input-dark" required>
                        </div>
                        <div>
                            <label class="auth-label-dark" for="signUpLastName">LAST NAME</label>
                            <input type="text" id="signUpLastName" class="auth-input-dark" required>
                        </div>

                        <!-- Row 2: Email -->
                        <div class="auth-field-full">
                            <label class="auth-label-dark" for="signUpEmail">EMAIL ADDRESS</label>
                            <input type="email" id="signUpEmail" class="auth-input-dark" required>
                        </div>

                        <!-- Row 3: City & Role -->
                        <div>
                            <label class="auth-label-dark" for="signUpCity">CITY OF RESIDENCE</label>
                            <input type="text" id="signUpCity" class="auth-input-dark" placeholder="e.g. Basel"
                                required>
                        </div>
                        <div>
                            <label class="auth-label-dark" for="signUpRole">ROLE In Community</label>
                            <select id="signUpRole" class="auth-input-dark" required style="cursor: pointer;">
                                <option value="" disabled selected>Select Role</option>
                                <option value="Student">Student</option>
                                <option value="Teacher">Teacher</option>
                                <option value="Dancer">Dancer</option>
                                <option value="Performer">Performer</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>

                        <!-- Row 4: WhatsApp -->
                        <div class="auth-field-full">
                            <label class="auth-label-dark" for="signUpWhatsapp">WHATSAPP NUMBER</label>
                            <input type="tel" id="signUpWhatsapp" class="auth-input-dark"
                                placeholder="+41 79 123 45 67">
                        </div>

                        <!-- Row 5: Password -->
                        <div class="auth-field-full">
                            <label class="auth-label-dark" for="signUpPassword">PASSWORD</label>
                            <input type="password" id="signUpPassword" class="auth-input-dark" required minlength="6">
                        </div>
                    </div>

                    <button type="submit" class="btn-auth-red">REGISTER NOW</button>
                </form>
            </div>

            <!-- Messages -->
            <div id="authMessage" style="margin-top: 1.5rem; text-align: center; font-weight: 600; display: none;">
            </div>

        </div>
    </div>

    <script>
        // --- Authentication Logic ---

        // Get redirect parameters
        const urlParams = new URLSearchParams(window.location.search);
        const redirectTo = urlParams.get('redirect') || 'registration-bachata-sensual.html';
        const track = urlParams.get('track');
        const level = urlParams.get('level');

        // View Switching
        function switchView(view) {
            const signInView = document.getElementById('signInView');
            const signUpView = document.getElementById('signUpView');
            const authMessage = document.getElementById('authMessage');

            const tabSignIn = document.getElementById('tabSignIn');
            const tabSignUp = document.getElementById('tabSignUp');

            authMessage.style.display = 'none';

            if (view === 'signIn') {
                signInView.style.display = 'block';
                signUpView.style.display = 'none';

                tabSignIn.classList.add('active');
                tabSignUp.classList.remove('active');
            } else {
                signInView.style.display = 'none';
                signUpView.style.display = 'block';

                tabSignIn.classList.remove('active');
                tabSignUp.classList.add('active');
            }
        }

        // Message Helper
        function showMessage(msg, isError = false) {
            const el = document.getElementById('authMessage');
            el.textContent = msg;
            el.style.color = isError ? '#ff6b6b' : '#4cd137';
            el.style.display = 'block';
        }

        // Hashing
        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hash = await crypto.subtle.digest('SHA-256', data);
            return Array.from(new Uint8Array(hash))
                .map(b => b.toString(16).padStart(2, '0'))
                .join('');
        }

        // --- Sign Up ---
        document.getElementById('signUpForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const firstName = document.getElementById('signUpFirstName').value.trim();
            const lastName = document.getElementById('signUpLastName').value.trim();
            const email = document.getElementById('signUpEmail').value.trim().toLowerCase();
            const city = document.getElementById('signUpCity').value.trim();
            const role = document.getElementById('signUpRole').value;
            const whatsapp = document.getElementById('signUpWhatsapp').value.trim();
            const password = document.getElementById('signUpPassword').value;

            // Simple validation
            if (!firstName || !lastName || !email || !password || !city || !role) {
                showMessage('Please fill in all required fields.', true);
                return;
            }

            // Check existing user
            const users = JSON.parse(localStorage.getItem('masterylab_users') || '{}');
            if (users[email]) {
                showMessage('An account with this email already exists.', true);
                return;
            }

            // Create User Object
            const hashedPassword = await hashPassword(password);
            const newUser = {
                firstName,
                lastName,
                email,
                city,
                role,
                whatsapp,
                password: hashedPassword,
                createdAt: new Date().toISOString()
            };

            // Save
            users[email] = newUser;
            localStorage.setItem('masterylab_users', JSON.stringify(users));

            // Set Current Session
            // We strip the password from the session object for safety
            const sessionUser = { ...newUser };
            delete sessionUser.password;

            localStorage.setItem('masterylab_current_user', JSON.stringify(sessionUser));

            showMessage('Account created! Redirecting...');

            // Redirect
            let redirectUrl = redirectTo;
            const params = [];
            if (track) params.push(`track=${track}`);
            if (level) params.push(`level=${level}`);

            if (params.length > 0) {
                redirectUrl += (redirectUrl.includes('?') ? '&' : '?') + params.join('&');
            }

            setTimeout(() => {
                window.location.href = redirectUrl;
            }, 1500);
        });

        // --- Sign In ---
        document.getElementById('signInForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const email = document.getElementById('signInEmail').value.trim().toLowerCase();
            const password = document.getElementById('signInPassword').value;

            const users = JSON.parse(localStorage.getItem('masterylab_users') || '{}');
            const user = users[email];

            if (!user) {
                showMessage('No account found with this email.', true);
                return;
            }

            const hashedPassword = await hashPassword(password);
            if (user.password !== hashedPassword) {
                showMessage('Incorrect password.', true);
                return;
            }

            // Set Session
            const sessionUser = { ...user };
            delete sessionUser.password;
            localStorage.setItem('masterylab_current_user', JSON.stringify(sessionUser));

            showMessage('Sign in successful! Redirecting...');

            // Redirect
            let redirectUrl = redirectTo;
            const params = [];
            if (track) params.push(`track=${track}`);
            if (level) params.push(`level=${level}`);

            if (params.length > 0) {
                redirectUrl += (redirectUrl.includes('?') ? '&' : '?') + params.join('&');
            }

            setTimeout(() => {
                window.location.href = redirectUrl;
            }, 1000);
        });

    </script>

</body>

</html>